<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vehicle Details | Avahanaa</title>
    <link rel="icon" type="image/jpeg" href="./logo.jpg" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.1/dist/flatly/bootstrap.min.css"
    />
    <style>
      body {
        min-height: 100vh;
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #0a304e 0%, #00a3cc 100%);
        color: #0a304e;
      }
      main {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2.5rem 1rem;
      }
      .card {
        width: 100%;
        max-width: 640px;
        border: none;
        border-radius: 1.25rem;
        box-shadow: 0 20px 50px rgba(10, 48, 78, 0.2);
      }
      .card-header {
        border-top-left-radius: 1.25rem;
        border-top-right-radius: 1.25rem;
        background: rgba(10, 48, 78, 0.06);
      }
      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
      }
      .pill {
        border-radius: 0.85rem;
        background: #f4f9fc;
        border: 1px solid rgba(10, 48, 78, 0.08);
        padding: 1rem;
        min-height: 112px;
      }
      .pill-label {
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(10, 48, 78, 0.6);
        margin-bottom: 0.35rem;
      }
      .pill-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: #0a304e;
        word-wrap: break-word;
      }
      .brand {
        font-weight: 600;
        letter-spacing: 0.08em;
        color: rgba(10, 48, 78, 0.65);
      }
      .qr-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border-radius: 999px;
        padding: 0.4rem 0.75rem;
        background: rgba(24, 188, 156, 0.1);
        color: #0a304e;
        font-weight: 500;
        border: 1px solid rgba(24, 188, 156, 0.25);
      }
      .alert strong {
        font-weight: 600;
      }
      .footer-links a {
        color: rgba(10, 48, 78, 0.75);
        text-decoration: none;
      }
      .footer-links a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="card bg-white">
        <div class="card-header py-3 px-4 d-flex flex-column flex-sm-row justify-content-between gap-2">
          <div class="d-flex align-items-center gap-2">
            <img
              src="./logo.jpg"
              alt="Avahanaa logo"
              width="40"
              height="40"
              class="rounded-circle border border-light"
            />
            <div>
              <div class="brand small text-uppercase">Avahanaa</div>
              <div class="fw-semibold text-dark">Vehicle Snapshot</div>
            </div>
          </div>
          <div id="qrWrap" class="d-none">
            <span class="qr-chip"
              ><span class="small text-uppercase text-muted">QR</span>
              <span id="qrValue" class="fw-semibold">—</span></span
            >
          </div>
        </div>
        <div class="card-body p-4">
          <div id="statusMessage" class="alert d-none mb-4" role="alert"></div>

          <div class="mb-4">
            <h2 id="vehicleTitle" class="h4 fw-semibold text-dark mb-1">
              Vehicle details pending…
            </h2>
            <p id="vehicleSubtitle" class="text-muted mb-0">
              We are loading the information shared by the owner.
            </p>
          </div>

          <div id="detailsSection" class="detail-grid mb-4 d-none">
            <div class="pill">
              <div class="pill-label">Vehicle</div>
              <div id="carModelValue" class="pill-value">—</div>
            </div>
            <div class="pill">
              <div class="pill-label">License Plate</div>
              <div id="licensePlateValue" class="pill-value">—</div>
            </div>
            <div class="pill">
              <div class="pill-label">Colour</div>
              <div id="colorValue" class="pill-value">—</div>
            </div>
          </div>

          <div class="d-flex flex-column flex-md-row gap-3">
            <button
              id="notifyOwnerBtn"
              type="button"
              class="btn btn-primary px-4"
              disabled
            >
              Notify this owner
            </button>
            <a href="index.html" class="btn btn-outline-secondary px-4">
              Back to homepage
            </a>
          </div>
          <p id="notifyOwnerFeedback" class="small text-muted mt-2 d-none"></p>
        </div>
        <div class="card-footer bg-white border-0 text-center text-muted small py-3">
          <div class="footer-links">
            <a href="mailto:hello@avahanaa.com">Support</a>
            <span class="mx-2">•</span>
            <a href="index.html?page=about">About Avahanaa</a>
          </div>
        </div>
      </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
    <script>
      (async function () {
        const params = new URLSearchParams(window.location.search);

        const elements = {
          status: document.getElementById("statusMessage"),
          detailsSection: document.getElementById("detailsSection"),
          vehicleTitle: document.getElementById("vehicleTitle"),
          vehicleSubtitle: document.getElementById("vehicleSubtitle"),
          carModel: document.getElementById("carModelValue"),
          licensePlate: document.getElementById("licensePlateValue"),
          color: document.getElementById("colorValue"),
          qrWrap: document.getElementById("qrWrap"),
          qrValue: document.getElementById("qrValue"),
          notifyButton: document.getElementById("notifyOwnerBtn"),
          notifyFeedback: document.getElementById("notifyOwnerFeedback"),
        };

        const DEFAULT_KEY = "0123456789abcdef0123456789abcdef";
        const DEFAULT_IV = "abcdef9876543210";
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();

        const firebaseConfig = {
          apiKey: "AIzaSyDVB09QVh9YizQ7p1YXGcQWQ_43NV6f0SE",
          authDomain: "congestion-free.firebaseapp.com",
          projectId: "congestion-free",
          storageBucket: "congestion-free.firebasestorage.app",
          messagingSenderId: "76007537447",
          appId: "1:76007537447:web:57a848570f39091b5a4702",
          measurementId: "G-5PNGPJZL6D",
        };

        let firestoreInstance = null;
        let functionsInstance = null;
        let analyticsInitialised = false;
        let statusPreset = null;

        const notificationState = {
          qrId: params.get("qr")?.trim() || "",
          fcmToken: "",
          userId: "",
          sending: false,
          ready: false,
        };
        const { qrId } = notificationState;

        if (qrId) {
          elements.qrWrap.classList.remove("d-none");
          elements.qrValue.textContent = qrId;
        }

        function setStatus(message, variant) {
          if (!message) {
            elements.status.classList.add("d-none");
            elements.status.textContent = "";
            return;
          }
          elements.status.className = `alert alert-${variant} mb-4`;
          elements.status.textContent = message;
        }

        function setNotifyFeedback(message, variant = "muted") {
          const el = elements.notifyFeedback;
          if (!el) return;
          if (!message) {
            el.classList.add("d-none");
            el.textContent = "";
            return;
          }
          const variants = {
            success: "text-success",
            danger: "text-danger",
            warning: "text-warning",
            info: "text-info",
            muted: "text-muted",
          };
          el.className = `small mt-2 ${variants[variant] || "text-muted"}`;
          el.textContent = message;
        }

        function updateNotifyButton(state) {
          const button = elements.notifyButton;
          if (!button) return;
          const baseLabel = "Notify this owner";
          if (state === "sending") {
            button.disabled = true;
            button.textContent = "Sending…";
          } else if (state === "ready") {
            button.disabled = false;
            button.textContent = baseLabel;
          } else if (state === "loading") {
            button.disabled = true;
            button.textContent = "Preparing…";
          } else {
            button.disabled = true;
            button.textContent = baseLabel;
          }
        }

        function normalisePlate(value) {
          if (!value) return "";
          return value.trim().toUpperCase();
        }

        function getEncryptionConfig() {
          const overrideKey =
            (window.QR_ENCRYPTION_KEY ||
              window.__QR_ENCRYPTION_KEY ||
              "").trim();
          const overrideIv =
            (window.QR_ENCRYPTION_IV || window.__QR_ENCRYPTION_IV || "").trim();
          return {
            key: overrideKey || DEFAULT_KEY,
            iv: overrideIv || DEFAULT_IV,
          };
        }

        function base64ToBytes(value) {
          const cleaned = value.replace(/\s+/g, "");
          const normalised = cleaned.replace(/-/g, "+").replace(/_/g, "/");
          const padded =
            normalised + "=".repeat((4 - (normalised.length % 4 || 4)) % 4);
          const binary = atob(padded);
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i += 1) {
            bytes[i] = binary.charCodeAt(i);
          }
          return bytes;
        }

        function removePkcs7Padding(bytes) {
          if (!bytes.length) {
            return bytes;
          }
          const pad = bytes[bytes.length - 1];
          if (pad < 1 || pad > 16) {
            throw new Error("Invalid padding detected");
          }
          for (let i = bytes.length - pad; i < bytes.length; i += 1) {
            if (bytes[i] !== pad) {
              throw new Error("Invalid padding detected");
            }
          }
          return bytes.slice(0, bytes.length - pad);
        }

        const subtleCrypto =
          (window.crypto && (window.crypto.subtle || window.crypto.webkitSubtle)) ||
          null;

        async function decodePayload(payload) {
          if (!subtleCrypto) {
            throw new Error("Web Crypto API is unavailable in this browser.");
          }
          const encryptedBytes = base64ToBytes(payload);
          const { key, iv } = getEncryptionConfig();
          const keyBytes = encoder.encode(key);
          if (![16, 24, 32].includes(keyBytes.length)) {
            throw new Error("QR encryption key must be 16, 24, or 32 bytes.");
          }
          const ivBytes = encoder.encode(iv);
          if (ivBytes.length !== 16) {
            throw new Error("QR encryption IV must be 16 bytes.");
          }
          const cryptoKey = await subtleCrypto.importKey(
            "raw",
            keyBytes,
            { name: "AES-CBC" },
            false,
            ["decrypt"]
          );
          const decryptedBuffer = await subtleCrypto.decrypt(
            { name: "AES-CBC", iv: ivBytes },
            cryptoKey,
            encryptedBytes
          );
          const plainBytes = removePkcs7Padding(
            new Uint8Array(decryptedBuffer)
          );
          const jsonString = decoder.decode(plainBytes);
          const parsed = JSON.parse(jsonString);
          if (!parsed || typeof parsed !== "object") {
            return null;
          }
          const clean = {};
          ["color", "carModel", "licensePlate"].forEach((keyName) => {
            const value = parsed[keyName];
            if (typeof value === "string" && value.trim()) {
              clean[keyName] = value.trim();
            }
          });
          return Object.keys(clean).length ? clean : null;
        }

        function ensureFirebaseApp() {
          if (!window.firebase || !window.firebase.apps) {
            console.warn("Firebase SDK is not available on this page.");
            return null;
          }
          try {
            if (firebase.apps.length === 0) {
              firebase.initializeApp(firebaseConfig);
            }
            if (!analyticsInitialised && typeof firebase.analytics === "function") {
              try {
                firebase.analytics();
              } catch (error) {
                console.warn("Analytics initialisation failed", error);
              }
              analyticsInitialised = true;
            }
            return firebase.app();
          } catch (error) {
            console.warn("Failed to initialise Firebase", error);
            return null;
          }
        }

        function ensureFirestore() {
          if (firestoreInstance) {
            return firestoreInstance;
          }
          const app = ensureFirebaseApp();
          if (!app) {
            return null;
          }
          try {
            firestoreInstance = firebase.firestore();
            return firestoreInstance;
          } catch (error) {
            console.warn("Failed to initialise Firebase", error);
            firestoreInstance = null;
            return null;
          }
        }

        function ensureFunctions() {
          if (functionsInstance) {
            return functionsInstance;
          }
          if (!window.firebase || !window.firebase.apps) {
            console.warn("Firebase SDK is not available on this page.");
            return null;
          }
          const app = ensureFirebaseApp();
          if (!app) {
            return null;
          }
          try {
            functionsInstance = firebase.functions();
            return functionsInstance;
          } catch (error) {
            console.warn("Failed to initialise Firebase Functions", error);
            functionsInstance = null;
            return null;
          }
        }

        async function fetchOwnerByQr(qrCodeId, firestore) {
          const db = firestore || ensureFirestore();
          if (!db || !qrCodeId) {
            return null;
          }
          try {
            const qrDoc = await db.collection("qrCodes").doc(qrCodeId).get();
            if (!qrDoc.exists) {
              return null;
            }
            const qrData = qrDoc.data() || {};
            const metadata =
              qrData.metadata && typeof qrData.metadata === "object"
                ? qrData.metadata
                : {};
            const metadataContact =
              metadata.contact && typeof metadata.contact === "object"
                ? metadata.contact
                : {};
            const userId = qrData.userId || metadata.userId || "";
            const owner = {
              userId,
              contact: {
                email:
                  typeof metadataContact.email === "string"
                    ? metadataContact.email
                    : "",
                phoneNumber:
                  typeof metadataContact.phoneNumber === "string"
                    ? metadataContact.phoneNumber
                    : "",
              },
              carDetails:
                metadata.carDetails && typeof metadata.carDetails === "object"
                  ? metadata.carDetails
                  : {},
              fcmToken: "",
            };
            if (userId) {
              const userDoc = await db.collection("users").doc(userId).get();
              if (userDoc.exists) {
                const userData = userDoc.data() || {};
                if (typeof userData.fcmToken === "string") {
                  owner.fcmToken = userData.fcmToken;
                }
                if (
                  (!owner.carDetails ||
                    !Object.keys(owner.carDetails).length) &&
                  userData.carDetails &&
                  typeof userData.carDetails === "object"
                ) {
                  owner.carDetails = userData.carDetails;
                }
                owner.contact = {
                  email:
                    owner.contact.email ||
                    (typeof userData.email === "string" ? userData.email : ""),
                  phoneNumber:
                    owner.contact.phoneNumber ||
                    (typeof userData.phoneNumber === "string"
                      ? userData.phoneNumber
                      : ""),
                };
              }
            }
            return owner;
          } catch (error) {
            console.warn("Failed to fetch owner profile for QR", error);
            return null;
          }
        }

        async function triggerNotifyFunction(payload) {
          const functions = ensureFunctions();
          if (!functions) {
            return {
              ok: false,
              message:
                "Notifications service is unavailable. Please try again in a moment.",
            };
          }
          try {
            const callable = functions.httpsCallable("notifyOwner");
            const response = await callable(payload);
            const result = (response && response.data) || {};
            if (result.ok) {
              return { ok: true };
            }
            return {
              ok: false,
              message: result.message || "Failed to deliver notification.",
            };
          } catch (error) {
            console.error("Notification function error:", error);
            const details = error?.details;
            return {
              ok: false,
              message:
                (details && details.message) ||
                error?.message ||
                "Notification request failed.",
            };
          }
        }

        const details = {
          carModel: "",
          licensePlate: "",
          color: "",
        };

        ["carModel", "licensePlate", "color"].forEach((key) => {
          const raw = params.get(key);
          if (typeof raw === "string" && raw.trim()) {
            details[key] = raw.trim();
          }
        });

        if (details.licensePlate) {
          details.licensePlate = normalisePlate(details.licensePlate);
        }

        let detailsSource = Object.values(details).some(Boolean)
          ? "link"
          : "none";

        const payload = params.get("payload")?.trim();
        let decoded = null;
        if (payload) {
          try {
            // Temporarily bypass AES decryption while the app sends plain payloads.
            decoded = JSON.parse(payload);
            if (decoded) {
              Object.assign(details, {
                carModel: decoded.carModel || details.carModel,
                licensePlate: decoded.licensePlate
                  ? normalisePlate(decoded.licensePlate)
                  : details.licensePlate,
                color: decoded.color || details.color,
              });
              detailsSource = "payload";
            } else {
              statusPreset = {
                message: "No car specifics were included in the payload.",
                variant: "info",
              };
            }
          } catch (error) {
            console.warn("Failed to parse payload", error);
            statusPreset = {
              message:
                "We could not read the shared vehicle details. Please contact the owner directly if possible.",
              variant: "warning",
            };
          }
        }

        function refreshDetailsView(context) {
          const hasAny = Object.values(details).some(Boolean);
          if (hasAny) {
            document.title = details.licensePlate
              ? `${details.licensePlate} | Avahanaa`
              : "Vehicle Details | Avahanaa";
            elements.vehicleTitle.textContent = details.carModel || "Vehicle";
            elements.vehicleSubtitle.textContent = details.licensePlate
              ? `License plate ${details.licensePlate}`
              : "Vehicle details shared by the owner.";
            elements.carModel.textContent = details.carModel || "Not provided";
            elements.licensePlate.textContent =
              details.licensePlate || "Not provided";
            elements.color.textContent = details.color || "Not provided";
            elements.detailsSection.classList.remove("d-none");
            if (statusPreset) {
              setStatus(statusPreset.message, statusPreset.variant);
            } else if (context === "payload") {
              setStatus(
                "These details were shared by the owner via the Avahanaa app.",
                "success"
              );
            } else if (context === "link") {
              setStatus(
                "These details were read directly from the link. For the most precise information, request the owner to update their app.",
                "info"
              );
            } else if (context === "metadata") {
              setStatus(
                "These details were retrieved from the owner's Avahanaa profile.",
                "info"
              );
            }
          } else if (qrId) {
            elements.vehicleTitle.textContent =
              "Vehicle details are not available.";
            elements.vehicleSubtitle.textContent =
              "The QR code is valid but no car specifics were shared.";
            if (statusPreset) {
              setStatus(statusPreset.message, statusPreset.variant);
            } else {
              setStatus(
                "Only the QR identifier was provided with this link. Ask the owner to update their vehicle profile in the app to share more details.",
                "info"
              );
            }
          } else {
            elements.vehicleTitle.textContent =
              "We could not find a QR reference.";
            elements.vehicleSubtitle.textContent =
              "Please double-check the link in the Avahanaa app.";
            if (statusPreset) {
              setStatus(statusPreset.message, statusPreset.variant);
            } else {
              setStatus(
                "No QR identifier or vehicle details were found in this link.",
                "danger"
              );
            }
          }
          statusPreset = null;
        }

        refreshDetailsView(detailsSource);

        if (elements.notifyButton) {
          elements.notifyButton.addEventListener("click", async () => {
            if (!notificationState.ready || notificationState.sending) {
              return;
            }
            notificationState.sending = true;
            updateNotifyButton("sending");
            setNotifyFeedback("Sending notification…", "info");
            const title = details.licensePlate
              ? `Vehicle Alert – ${details.licensePlate}`
              : "Vehicle Alert";
            const body =
              "A visitor is requesting your attention at your vehicle via Avahanaa.";
            const metadata = {
              reason: "other",
              message: body,
            };
            if (details.licensePlate) {
              metadata.licensePlate = details.licensePlate;
            }
            if (details.carModel) {
              metadata.carModel = details.carModel;
            }
            if (details.color) {
              metadata.color = details.color;
            }
            const result = await triggerNotifyFunction({
              qrId,
              userId: notificationState.userId,
              fcmToken: notificationState.fcmToken,
              title,
              body,
              metadata,
            });
            notificationState.sending = false;
            updateNotifyButton(notificationState.ready ? "ready" : "disabled");
            if (result.ok) {
              setNotifyFeedback(
                "Notification sent successfully to the owner's device.",
                "success"
              );
            } else {
              setNotifyFeedback(
                result.message || "Failed to send notification.",
                "danger"
              );
            }
          });
        }

        await prepareNotificationSupport();

        async function prepareNotificationSupport() {
          const button = elements.notifyButton;
          notificationState.ready = false;
          notificationState.fcmToken = "";
          notificationState.userId = "";
          if (!button) {
            return;
          }
          if (!qrId) {
            setNotifyFeedback(
              "Notifications are available only when you scan a registered Avahanaa QR code.",
              "muted"
            );
            updateNotifyButton("disabled");
            return;
          }
          updateNotifyButton("loading");
          setNotifyFeedback("Fetching owner profile…", "info");
          const functions = ensureFunctions();
          if (!functions) {
            setNotifyFeedback(
              "Notifications service is unavailable right now. Please try again later.",
              "danger"
            );
            updateNotifyButton("disabled");
            return;
          }
          const db = ensureFirestore();
          if (!db) {
            setNotifyFeedback(
              "We could not connect to the owner directory right now. Please try again shortly.",
              "danger"
            );
            updateNotifyButton("disabled");
            return;
          }
          const owner = await fetchOwnerByQr(qrId, db);
          if (!owner) {
            setNotifyFeedback(
              "This QR code is not yet linked to an owner profile. Ask them to open the Avahanaa app.",
              "warning"
            );
            updateNotifyButton("disabled");
            return;
          }
          let mergedDetails = false;
          if (!Object.values(details).some(Boolean) && owner.carDetails) {
            ["carModel", "licensePlate", "color"].forEach((key) => {
              const value = owner.carDetails[key];
              if (typeof value === "string" && value.trim() && !details[key]) {
                details[key] =
                  key === "licensePlate"
                    ? normalisePlate(value)
                    : value.trim();
                mergedDetails = true;
              }
            });
          }
          if (mergedDetails) {
            statusPreset = {
              message:
                "These details were retrieved automatically from the owner's Avahanaa profile.",
              variant: "info",
            };
            refreshDetailsView("metadata");
          }
          if (!owner.fcmToken) {
            setNotifyFeedback(
              "The owner has not enabled push notifications yet. Try contacting them using the details on the QR card.",
              "warning"
            );
            updateNotifyButton("disabled");
            return;
          }
          notificationState.fcmToken = owner.fcmToken;
          notificationState.userId = owner.userId || "";
          notificationState.ready = true;
          setNotifyFeedback("Ready to alert the owner instantly.", "muted");
          updateNotifyButton("ready");
        }
      })();
    </script>
  </body>
</html>
